<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Cafe-AR | Elit Menü</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,600;0,800;1,600&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; background: #0a0a0a; color: white; display: flex; flex-direction: column; height: 100vh; }
        .header { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 25px 20px; background: rgba(10, 10, 10, 0.9); border-bottom: 1px solid rgba(212, 175, 55, 0.2); z-index: 20; }
        .brand { font-family: 'Playfair Display', serif; font-size: 26px; font-weight: 800; color: #d4af37; letter-spacing: 2px; text-transform: uppercase; }
        .sub-brand { font-size: 13px; color: #a1a1aa; font-weight: 300; margin-top: 5px; letter-spacing: 4px; text-transform: uppercase; }
        .ar-container { flex: 1; position: relative; background: #111; display: flex; align-items: center; justify-content: center; }
        model-viewer { width: 100%; height: 100%; outline: none; --poster-color: transparent; }
        .bottom-panel { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; z-index: 10; text-align: center; }
        .info-card { background: rgba(20, 20, 20, 0.85); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.08); border-radius: 24px; padding: 25px 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.8); }
        .info-card h3 { font-family: 'Playfair Display', serif; color: #d4af37; margin: 0 0 10px 0; font-size: 22px; }
        .info-card p { color: #a1a1aa; font-size: 14px; margin: 0 0 20px 0; line-height: 1.5; }
        .btn-ar { background: linear-gradient(135deg, #d4af37 0%, #aa8c2c 100%); color: black; font-weight: 800; font-size: 16px; padding: 18px; border-radius: 16px; width: 100%; border: none; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px; box-shadow: 0 10px 25px rgba(212, 175, 55, 0.2); }
        .btn-ar:active { transform: scale(0.98); }
        #loader { position: absolute; top:0; left:0; width:100%; height:100%; background: #0a0a0a; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.5s; }
        .spinner { width: 40px; height: 40px; border: 3px solid #333; border-top: 3px solid #d4af37; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <div style="color: #d4af37; font-family: 'Playfair Display', serif; font-size: 18px;">Menü Hazırlanıyor...</div>
    </div>

    <div class="header">
        <div class="brand">THE RESTAURANT</div>
        <div class="sub-brand" id="kategoriBasligi">Menü</div>
    </div>

    <div class="ar-container">
        <model-viewer id="ar-gosterici"
            src="https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/BoxTextured/glTF-Binary/BoxTextured.glb"
            ar ar-modes="webxr scene-viewer quick-look"
            camera-controls 
            ar-placement="floor"
            scale="1.2 0.01 1.8"
            shadow-intensity="1.5"
            shadow-softness="0.8">
            <button slot="ar-button" style="display: none;"></button>
        </model-viewer>

        <div class="bottom-panel">
            <div class="info-card">
                <h3 id="panelBaslik">Masadaki Menü</h3>
                <p>Kameranızı masaya doğru tutun ve siparişinizi garsona iletmek için menümüzü inceleyin.</p>
                <button class="btn-ar" onclick="document.getElementById('ar-gosterici').activateAR()">
                    AR Menüyü Masaya Koy
                </button>
            </div>
        </div>
    </div>

    <script>
        const KULLANICI = "fthlabz";
        const REPO = "cafe-ar"; 
        
        async function sistemiBaslat() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const seciliKategori = urlParams.get('kategori') || 'Tümü';
                
                if(seciliKategori !== 'Tümü') {
                    document.getElementById('kategoriBasligi').innerText = seciliKategori.replace(/([A-Z])/g, ' $1').trim();
                    document.getElementById('panelBaslik').innerText = seciliKategori.replace(/([A-Z])/g, ' $1').trim() + " Menüsü";
                }

                const cevap = await fetch(`https://raw.githubusercontent.com/${KULLANICI}/${REPO}/main/menu.json?t=${Date.now()}`);
                if (cevap.ok) {
                    let menuVerisi = await cevap.json();
                    
                    if(seciliKategori !== 'Tümü') {
                        menuVerisi = menuVerisi.filter(u => u.kategori === seciliKategori);
                    }

                    await arMenuCiz(menuVerisi, seciliKategori);
                }
            } catch (e) { console.log(e); }
            
            setTimeout(() => {
                document.getElementById('loader').style.opacity = '0';
                setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
            }, 800);
        }

        async function arMenuCiz(veriler, kategori) {
            const canvas = document.createElement('canvas');
            // ÇİZİM ALANI DİKEY YAPILDI (Rotasyon iptal)
            canvas.width = 1200; 
            canvas.height = 1800; 
            const ctx = canvas.getContext('2d');

            // Zemin (Mat Siyah)
            ctx.fillStyle = '#111111';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // EĞER KATEGORİ BOŞSA
            if(veriler.length === 0) {
                ctx.fillStyle = '#d4af37';
                ctx.font = 'bold 50px "Playfair Display", serif';
                ctx.textAlign = 'center';
                ctx.fillText('Bu Kategoride Menü Bulunmuyor', canvas.width / 2, canvas.height / 2);
            } 
            // EĞER ÜRÜN VARSA
            else {
                // Çerçeve
                ctx.strokeStyle = '#d4af37';
                ctx.lineWidth = 8;
                ctx.strokeRect(40, 40, canvas.width - 80, canvas.height - 80);
                ctx.lineWidth = 2;
                ctx.strokeRect(52, 52, canvas.width - 104, canvas.height - 104);

                // Başlık
                ctx.fillStyle = '#d4af37';
                ctx.font = 'bold 70px "Playfair Display", serif';
                ctx.textAlign = 'center';
                ctx.fillText('THE RESTAURANT', canvas.width / 2, 150);

                ctx.fillStyle = '#aaaaaa';
                ctx.font = '35px Inter';
                ctx.fillText(kategori === 'Tümü' ? 'MENU' : kategori.toUpperCase(), canvas.width / 2, 210);

                ctx.beginPath();
                ctx.moveTo(canvas.width / 2 - 200, 250);
                ctx.lineTo(canvas.width / 2 + 200, 250);
                ctx.stroke();

                let startY = 350;
                
                for (const urun of veriler) {
                    if(startY > canvas.height - 200) break; // Sayfadan taşmasın

                    // ÜRÜN FOTOĞRAFI
                    if (urun.resim) {
                        try {
                            const img = await loadImage(urun.resim);
                            ctx.save();
                            ctx.beginPath();
                            ctx.roundRect ? ctx.roundRect(80, startY, 160, 160, 20) : ctx.rect(80, startY, 160, 160);
                            ctx.clip();
                            ctx.drawImage(img, 80, startY, 160, 160);
                            ctx.restore();
                            
                            ctx.strokeStyle = 'rgba(212, 175, 55, 0.5)';
                            ctx.lineWidth = 2;
                            ctx.roundRect ? ctx.strokeRect(80, startY, 160, 160, 20) : ctx.strokeRect(80, startY, 160, 160);
                        } catch(e) {
                            ctx.fillStyle = '#222';
                            ctx.fillRect(80, startY, 160, 160);
                        }
                    }

                    // YEMEK ADI
                    ctx.fillStyle = '#d4af37';
                    ctx.font = 'bold 42px "Playfair Display", serif';
                    ctx.textAlign = 'left';
                    ctx.fillText(urun.ad, 280, startY + 45);

                    // İÇİNDEKİLER
                    ctx.fillStyle = '#cccccc';
                    ctx.font = '28px Inter';
                    let icerikMetni = urun.icerik || "";
                    if(icerikMetni.length > 55) icerikMetni = icerikMetni.substring(0, 55) + "...";
                    ctx.fillText(icerikMetni, 280, startY + 95);

                    // KALORİ
                    ctx.fillStyle = '#777777';
                    ctx.font = 'italic 24px Inter';
                    if(urun.kalori) ctx.fillText(urun.kalori + ' kcal', 280, startY + 140);

                    // FİYAT
                    ctx.fillStyle = '#ffffff';
                    ctx.font = 'bold 45px Inter';
                    ctx.textAlign = 'right';
                    ctx.fillText(urun.fiyat + ' ₺', canvas.width - 80, startY + 85);

                    // Çizgi
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([10, 10]);
                    ctx.beginPath();
                    ctx.moveTo(280, startY + 190);
                    ctx.lineTo(canvas.width - 80, startY + 190);
                    ctx.stroke();
                    ctx.setLineDash([]); 

                    startY += 230; 
                }

                ctx.fillStyle = '#d4af37';
                ctx.font = 'italic 30px "Playfair Display", serif';
                ctx.textAlign = 'center';
                ctx.fillText('Afiyet Olsun', canvas.width / 2, canvas.height - 60);
            }

            // Texture'ı modele aktar
            const textureUrl = canvas.toDataURL('image/jpeg', 0.9);
            const mv = document.getElementById('ar-gosterici');
            
            await new Promise(r => setTimeout(r, 200)); 
            if (mv.model && mv.model.materials) {
                const texture = await mv.createTexture(textureUrl);
                const material = mv.model.materials[0];
                material.pbrMetallicRoughness.baseColorTexture.setTexture(texture);
                material.pbrMetallicRoughness.setBaseColorFactor([1, 1, 1, 1]);
            }
        }

        function loadImage(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = url;
            });
        }

        sistemiBaslat();
    </script>
</body>
</html>
