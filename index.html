<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Cafe-AR | Elite Totem</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Inter:wght@400;600;800&family=Montserrat:wght@900&display=swap" rel="stylesheet">
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; background: #050505; color: white; display: flex; flex-direction: column; height: 100vh; }
        
        .header { display: flex; flex-direction: column; align-items: center; padding: 25px 20px; background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(212, 175, 55, 0.3); z-index: 20; }
        .brand { font-family: 'Playfair Display', serif; font-size: 26px; color: #d4af37; text-transform: uppercase; letter-spacing: 3px; }
        .sub-brand { font-size: 12px; color: #888; font-weight: 600; margin-top: 6px; letter-spacing: 6px; text-transform: uppercase; }
        
        .ar-container { flex: 1; position: relative; display: flex; justify-content: center; align-items: center; background: radial-gradient(circle at center, #1a1a1a 0%, #000 80%); }
        
        /* Model Viewer Başlangıçta Görünmez (Yeşil logoyu gizler) */
        model-viewer { width: 100%; height: 100%; outline: none; opacity: 0; transition: opacity 0.6s ease-in-out; }
        
        /* ŞIK CAM BUTON */
        .btn-ar { 
            position: absolute; 
            bottom: 50px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: rgba(15, 15, 15, 0.8); 
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(212, 175, 55, 0.5); 
            color: #d4af37; 
            font-family: 'Inter', sans-serif;
            font-weight: 600; 
            padding: 16px 32px; 
            border-radius: 40px; 
            cursor: pointer; 
            font-size: 16px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.8); 
            z-index: 50;
            display: flex;
            align-items: center;
            gap: 12px;
            white-space: nowrap;
        }
        .btn-ar:active { transform: translateX(-50%) scale(0.95); background: rgba(212, 175, 55, 0.15); }
        .btn-ar svg { width: 22px; height: 22px; fill: #d4af37; }

        #loader { position: absolute; top:0; left:0; width:100%; height:100%; background: #000; z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 50px; height: 50px; border: 5px solid #333; border-top: 5px solid #d4af37; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;}
        .loading-text { font-family: 'Playfair Display', serif; color: #d4af37; font-size: 20px; font-weight: bold; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loader">
        <div class="spinner"></div>
        <div class="loading-text">Menü Hazırlanıyor...</div>
    </div>
    
    <div class="header">
        <div class="brand" id="tepeRestoranAdi">YÜKLENİYOR...</div>
        <div class="sub-brand" id="kategoriBasligi">Menü</div>
    </div>

    <div class="ar-container">
        <model-viewer id="ar-gosterici"
            src="https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/BoxTextured/glTF-Binary/BoxTextured.glb"
            ar ar-modes="webxr scene-viewer quick-look"
            camera-controls
            camera-orbit="0deg 90deg 4.5m"
            ar-placement="floor"
            scale="1.2 2.4 0.02"
            shadow-intensity="2">
            
            <button slot="ar-button" style="display: none;"></button>
            
            <button class="btn-ar" onclick="document.getElementById('ar-gosterici').activateAR()">
                <svg viewBox="0 0 24 24"><path d="M12 15a4 4 0 1 0 0-8 4 4 0 0 0 0 8zm0-2a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm9.3-5.2A19.5 19.5 0 0 0 12 3a19.5 19.5 0 0 0-9.3 4.8c-.4.4-.4 1 0 1.4L4 10.5c.4.4 1 .4 1.4 0A15.5 15.5 0 0 1 12 7c2.5 0 4.8.6 6.6 1.7.4.2 1 .1 1.4-.3l1.3-1.3c.4-.3.4-.9 0-1.3zM12 21c-2.5 0-4.8-.6-6.6-1.7-.4-.2-1-.1-1.4.3L2.7 21c-.4.3-.4.9 0 1.3A19.5 19.5 0 0 0 12 25a19.5 19.5 0 0 0 9.3-4.8c.4-.4.4-1 0-1.4l-1.3-1.3c-.4-.4-1-.4-1.4 0A15.5 15.5 0 0 1 12 21z"/></svg>
                Mekanda Görüntüle
            </button>
        </model-viewer>
    </div>

<script>
    const KULLANICI = "fthlabz"; const REPO = "cafe-ar";
    let isletmeAdi = "THE RESTAURANT";

    async function sistemiBaslat() {
        try {
            const a = await fetch(`https://raw.githubusercontent.com/${KULLANICI}/${REPO}/main/ayarlar.json?t=${Date.now()}`);
            if (a.ok) { const ayar = await a.json(); isletmeAdi = ayar.restoranAdi || isletmeAdi; }
            document.getElementById('tepeRestoranAdi').innerText = isletmeAdi;

            const url = new URLSearchParams(window.location.search);
            const kat = url.get('kategori') || 'Tümü';
            
            if(kat !== 'Tümü') {
                document.getElementById('kategoriBasligi').innerText = kat.replace(/([A-Z])/g, ' $1').trim();
            }

            const c = await fetch(`https://raw.githubusercontent.com/${KULLANICI}/${REPO}/main/menu.json?t=${Date.now()}`);
            if (c.ok) {
                let d = await c.json();
                if(kat !== 'Tümü') d = d.filter(u => u.kategori === kat);
                await arMenuCiz(d, kat);
            } else {
                await arMenuCiz([], kat);
            }
        } catch (e) {
            await arMenuCiz([], 'Tümü');
        }
    }

    async function arMenuCiz(veriler, kat) {
        const canvas = document.createElement('canvas'); 
        canvas.width = 1200; canvas.height = 2400; 
        const ctx = canvas.getContext('2d');
        
        ctx.translate(canvas.width, 0); 
        ctx.scale(-1, 1);
        
        const grd = ctx.createLinearGradient(0, 0, 0, canvas.height);
        grd.addColorStop(0, "#1a1a1a");
        grd.addColorStop(1, "#050505");
        ctx.fillStyle = grd; ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.strokeStyle = '#d4af37'; 
        ctx.lineWidth = 8; ctx.strokeRect(40, 40, canvas.width - 80, canvas.height - 80);
        ctx.lineWidth = 2; ctx.strokeRect(55, 55, canvas.width - 110, canvas.height - 110);
        
        ctx.fillStyle = '#d4af37'; ctx.textAlign = 'center';
        ctx.font = '900 80px Playfair Display'; ctx.fillText(isletmeAdi, 600, 180);
        ctx.fillStyle = '#aaaaaa';
        ctx.font = '800 35px Inter'; ctx.letterSpacing = "6px"; 
        ctx.fillText(kat === 'Tümü' ? 'MENÜ' : kat.toUpperCase(), 600, 250);
        
        ctx.beginPath(); ctx.moveTo(400, 290); ctx.lineTo(800, 290); ctx.stroke();

        if(veriler.length === 0) {
            ctx.fillStyle = '#d4af37'; ctx.font = 'bold 50px "Playfair Display", serif';
            ctx.textAlign = 'center'; ctx.fillText('Bu Kategoride Ürün Bulunmuyor', 600, 1200);
        } else {
            // AUTO-FIT (Sığdırma) MOTORU
            let maxCizimAlani = canvas.height - 550; 
            let urunSayisi = veriler.length;
            
            let bosluk = 310; 
            let rBoyut = 220;
            let bPunto = 50; 
            let fPunto = 55;
            let iPunto = 32;
            let kPunto = 26;

            if ((urunSayisi * bosluk) > maxCizimAlani) {
                let kucultmeOrani = maxCizimAlani / (urunSayisi * bosluk);
                bosluk = bosluk * kucultmeOrani;
                rBoyut = rBoyut * kucultmeOrani;
                bPunto = Math.max(25, bPunto * kucultmeOrani); 
                fPunto = Math.max(28, fPunto * kucultmeOrani);
                iPunto = Math.max(18, iPunto * kucultmeOrani);
                kPunto = Math.max(14, kPunto * kucultmeOrani);
            }

            let y = 380; 
            
            for (const u of veriler) {
                if(y > canvas.height - 150) break; 

                if (u.resim) { 
                    try {
                        const img = await new Promise(r => { const i = new Image(); i.crossOrigin="anonymous"; i.onload=()=>r(i); i.src=u.resim; });
                        ctx.save();
                        ctx.beginPath();
                        ctx.roundRect ? ctx.roundRect(100, y, rBoyut, rBoyut, 25) : ctx.rect(100, y, rBoyut, rBoyut);
                        ctx.clip();
                        ctx.drawImage(img, 100, y, rBoyut, rBoyut); 
                        ctx.restore();
                        ctx.strokeStyle = 'rgba(212, 175, 55, 0.4)'; ctx.lineWidth = 3;
                        ctx.roundRect ? ctx.strokeRect(100, y, rBoyut, rBoyut, 25) : ctx.strokeRect(100, y, rBoyut, rBoyut);
                    } catch(e) {}
                }

                ctx.textAlign = 'left'; 
                ctx.fillStyle = '#d4af37'; 
                ctx.font = `bold ${bPunto}px Playfair Display`;
                const adMetni = u.ad || "İsimsiz";
                ctx.fillText(adMetni, 140 + rBoyut, y + (rBoyut * 0.3)); 
                
                ctx.fillStyle = '#fff'; 
                ctx.font = `900 ${fPunto}px Inter`; 
                ctx.textAlign = 'right';
                const fiyatText = u.fiyat + ' ₺';
                ctx.fillText(fiyatText, 1100, y + (rBoyut * 0.3));

                ctx.font = `bold ${bPunto}px Playfair Display`;
                const adGenislik = ctx.measureText(adMetni).width;
                ctx.font = `900 ${fPunto}px Inter`;
                const fiyatGenislik = ctx.measureText(fiyatText).width;
                
                const dotStartX = 140 + rBoyut + adGenislik + 25; 
                const dotEndX = 1100 - fiyatGenislik - 25; 
                
                if (dotEndX > dotStartX) {
                    ctx.fillStyle = 'rgba(212,175,55,0.4)';
                    ctx.font = `bold ${bPunto * 0.8}px Inter`; 
                    ctx.textAlign = 'left';
                    for(let px = dotStartX; px < dotEndX; px += 20) {
                        ctx.fillText(".", px, y + (rBoyut * 0.25)); 
                    }
                }

                ctx.textAlign = 'left'; 
                ctx.fillStyle = '#cccccc'; 
                ctx.font = `${iPunto}px Inter`;
                const words = (u.icerik || "").split(' '); 
                let line = ''; 
                let ty = y + (rBoyut * 0.6); 
                
                for(let n=0; n < words.length; n++) {
                    let testLine = line + words[n] + ' ';
                    if (ctx.measureText(testLine).width > (900 - rBoyut) && n > 0) { 
                        ctx.fillText(line, 140 + rBoyut, ty); 
                        line = words[n] + ' '; 
                        ty += (iPunto * 1.4); 
                    } else { 
                        line = testLine; 
                    }
                }
                ctx.fillText(line, 140 + rBoyut, ty);
                
                if(u.kalori) { 
                    ctx.fillStyle = '#888888'; 
                    ctx.font = `italic ${kPunto}px Inter`; 
                    ctx.fillText(u.kalori + " kcal", 140 + rBoyut, ty + (kPunto * 1.5)); 
                }

                y += bosluk;
            }
        }

        ctx.fillStyle = '#777777'; 
        ctx.font = '900 35px Montserrat'; 
        ctx.textAlign = 'center';
        ctx.letterSpacing = "3px";
        ctx.fillText('POWERED BY FTHLABZ', 600, canvas.height - 60);

        const mv = document.getElementById('ar-gosterici');
        if (mv.model) {
            const tex = await mv.createTexture(canvas.toDataURL('image/jpeg', 0.9));
            mv.model.materials[0].pbrMetallicRoughness.baseColorTexture.setTexture(tex);
        }
        
        // Loader'ı Kapat ve Modeli Görünür Yap (Perde açılır)
        document.getElementById('loader').style.display = 'none';
        mv.style.opacity = '1';
    }
    
    sistemiBaslat();
</script>
</body>
</html>
